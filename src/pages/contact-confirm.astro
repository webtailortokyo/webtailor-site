---
// お問い合わせ確認画面
// フォームで入力されたデータを確認し、「戻る」「送信」ボタンを表示
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout 
  title="お問い合わせ内容の確認"
  description="お問い合わせ内容をご確認ください。内容に間違いがなければ送信ボタンを押してください。"
  currentPath="/contact-confirm"
>
  <!-- ヒーローセクション -->
  <section class="pt-32 pb-16 bg-gradient-primary relative overflow-hidden">
    <!-- 装飾的な背景要素 -->
    <div class="absolute inset-0">
      <div class="absolute top-1/4 right-1/4 w-48 h-48 bg-white/5 rounded-full blur-2xl"></div>
      <div class="absolute bottom-1/4 left-1/4 w-32 h-32 bg-primary-300/20 rounded-full blur-xl"></div>
    </div>
    
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
      <div class="max-w-4xl mx-auto text-center space-y-6">
        <h1 class="text-4xl md:text-5xl font-bold text-accent-800 fade-in-up">
          お問い合わせ内容の確認
        </h1>
        <p class="text-xl text-accent-600 fade-in-up" style="animation-delay: 0.2s;">
          以下の内容で送信いたします
        </p>
      </div>
    </div>
  </section>

  <!-- 確認内容セクション -->
  <section class="section-padding bg-white">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="max-w-4xl mx-auto">
        <!-- データが存在しない場合の警告メッセージ -->
        <div id="no-data-warning" class="bg-amber-50 border-l-4 border-amber-400 p-6 rounded-lg mb-8 hidden">
          <div class="flex">
            <svg class="w-6 h-6 text-amber-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
            </svg>
            <div>
              <h3 class="text-amber-800 font-medium">お問い合わせデータが見つかりません</h3>
              <p class="text-amber-700 mt-1">お問い合わせフォームから改めて入力してください。</p>
              <a href="/contact" class="text-amber-600 hover:text-amber-500 font-medium underline mt-2 inline-block">
                お問い合わせフォームに戻る
              </a>
            </div>
          </div>
        </div>

        <!-- 確認内容表示エリア -->
        <div id="confirm-content" class="space-y-8">
          <!-- 確認内容 -->
          <div class="bg-gradient-to-r from-primary-50/50 to-accent-50/50 p-8 md:p-12 rounded-2xl shadow-lg">
            <h2 class="text-2xl font-bold text-accent-800 mb-8 text-center">ご入力内容</h2>
            
            <div class="space-y-6">
              <!-- お名前 -->
              <div class="border-b border-neutral-200 pb-4 fade-in-up">
                <div class="flex flex-col sm:flex-row sm:items-center">
                  <div class="text-lg font-semibold text-accent-800 mb-2 sm:mb-0 sm:w-40">お名前</div>
                  <div class="text-lg text-neutral-700" id="confirm-name"></div>
                </div>
              </div>

              <!-- メールアドレス -->
              <div class="border-b border-neutral-200 pb-4 fade-in-up" style="animation-delay: 0.1s;">
                <div class="flex flex-col sm:flex-row sm:items-center">
                  <div class="text-lg font-semibold text-accent-800 mb-2 sm:mb-0 sm:w-40">メールアドレス</div>
                  <div class="text-lg text-neutral-700" id="confirm-email"></div>
                </div>
              </div>

              <!-- 電話番号 -->
              <div class="border-b border-neutral-200 pb-4 fade-in-up" style="animation-delay: 0.2s;" id="phone-section">
                <div class="flex flex-col sm:flex-row sm:items-center">
                  <div class="text-lg font-semibold text-accent-800 mb-2 sm:mb-0 sm:w-40">電話番号</div>
                  <div class="text-lg text-neutral-700" id="confirm-phone"></div>
                </div>
              </div>

              <!-- 件名 -->
              <div class="border-b border-neutral-200 pb-4 fade-in-up" style="animation-delay: 0.3s;">
                <div class="flex flex-col sm:flex-row sm:items-start">
                  <div class="text-lg font-semibold text-accent-800 mb-2 sm:mb-0 sm:w-40">件名</div>
                  <div class="text-lg text-neutral-700" id="confirm-subject"></div>
                </div>
              </div>

              <!-- 予算 -->
              <div class="border-b border-neutral-200 pb-4 fade-in-up" style="animation-delay: 0.4s;" id="budget-section">
                <div class="flex flex-col sm:flex-row sm:items-start">
                  <div class="text-lg font-semibold text-accent-800 mb-2 sm:mb-0 sm:w-40">ご予算</div>
                  <div class="text-lg text-neutral-700" id="confirm-budget"></div>
                </div>
              </div>

              <!-- 希望納期 -->
              <div class="border-b border-neutral-200 pb-4 fade-in-up" style="animation-delay: 0.5s;" id="deadline-section">
                <div class="flex flex-col sm:flex-row sm:items-start">
                  <div class="text-lg font-semibold text-accent-800 mb-2 sm:mb-0 sm:w-40">希望納期</div>
                  <div class="text-lg text-neutral-700" id="confirm-deadline"></div>
                </div>
              </div>

              <!-- メッセージ -->
              <div class="fade-in-up" style="animation-delay: 0.6s;">
                <div class="flex flex-col sm:flex-row sm:items-start">
                  <div class="text-lg font-semibold text-accent-800 mb-2 sm:mb-0 sm:w-40">メッセージ</div>
                  <div class="text-lg text-neutral-700 whitespace-pre-wrap flex-1" id="confirm-message"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- 送信フォーム -->
          <form id="send-form" action="/contact-send.php" method="POST" class="hidden">
            <input type="hidden" name="name" id="hidden-name">
            <input type="hidden" name="email" id="hidden-email">
            <input type="hidden" name="phone" id="hidden-phone">
            <input type="hidden" name="subject" id="hidden-subject">
            <input type="hidden" name="budget" id="hidden-budget">
            <input type="hidden" name="deadline" id="hidden-deadline">
            <input type="hidden" name="message" id="hidden-message">
            <input type="hidden" name="privacy" value="on">
          </form>

          <!-- アクションボタン -->
          <div class="flex flex-col sm:flex-row gap-4 justify-center items-center pt-8 fade-in-up" style="animation-delay: 0.7s;">
            <button 
              type="button"
              id="back-btn"
              class="w-full sm:w-auto bg-neutral-200 hover:bg-neutral-300 text-neutral-800 px-8 py-4 rounded-lg font-medium transition-all duration-300 hover:shadow-lg order-2 sm:order-1"
            >
              ← 入力画面に戻る
            </button>
            <button 
              type="button"
              id="send-btn"
              class="w-full sm:w-auto btn-gradient text-lg px-12 py-4 hover:shadow-xl transform hover:scale-105 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed order-1 sm:order-2"
            >
              <span id="send-text">送信する</span>
              <svg id="send-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </button>
          </div>

          <!-- 注意事項 -->
          <div class="bg-blue-50 border-l-4 border-blue-400 p-6 rounded-lg fade-in-up" style="animation-delay: 0.8s;">
            <div class="flex">
              <svg class="w-6 h-6 text-blue-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
              </svg>
              <div>
                <h3 class="text-blue-800 font-medium">送信について</h3>
                <ul class="text-blue-700 mt-1 space-y-1 text-sm">
                  <li>• ご返信には数営業日いただく場合がございます</li>
                  <li>• 送信後、自動返信メールをお送りいたします</li>
                  <li>• 迷惑メールフォルダもご確認ください</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<!-- 確認画面用JavaScript -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const confirmContent = document.getElementById('confirm-content');
    const noDataWarning = document.getElementById('no-data-warning');
    const backBtn = document.getElementById('back-btn');
    const sendBtn = document.getElementById('send-btn') as HTMLButtonElement;
    const sendForm = document.getElementById('send-form');
    const sendText = document.getElementById('send-text');
    const sendSpinner = document.getElementById('send-spinner');
    
    // セッションストレージからデータを取得
    const formDataString = sessionStorage.getItem('contactFormData');
    
    if (!formDataString) {
      // データがない場合は警告を表示
      confirmContent.classList.add('hidden');
      noDataWarning.classList.remove('hidden');
      return;
    }
    
    try {
      const formData = JSON.parse(formDataString);
      
      // 確認画面にデータを表示
      displayConfirmData(formData);
      
      // 戻るボタンの処理
      backBtn.addEventListener('click', function() {
        window.location.href = '/contact';
      });
      
      // 送信ボタンの処理
      sendBtn.addEventListener('click', function() {
        // 送信確認
        if (!confirm('お問い合わせを送信してもよろしいですか？')) {
          return;
        }
        
        // ローディング状態にする
        sendBtn.disabled = true;
        sendText.classList.add('hidden');
        sendSpinner.classList.remove('hidden');
        
        // 隠しフォームにデータを設定
        setHiddenFormData(formData);
        
        // PHPに送信（実際の実装では適切な処理を行う）
        // setTimeout(() => {
        //   // セッションストレージをクリア
        //   sessionStorage.removeItem('contactFormData');
          
        //   // サンクスページに遷移
        //   window.location.href = '/contact-thanks';
        // }, 1000);

        // 実際にPHPに送信
        const sendFormEl = document.getElementById('send-form') as HTMLFormElement;
        sendFormEl.submit();
        // セッションストレージをクリア
        sessionStorage.removeItem('contactFormData');

      });
      
    } catch (error) {
      console.error('データの解析に失敗しました:', error);
      confirmContent.classList.add('hidden');
      noDataWarning.classList.remove('hidden');
    }
    
    // 確認データを表示する関数
    function displayConfirmData(data) {
      // 必須項目
      document.getElementById('confirm-name').textContent = data.name || '';
      document.getElementById('confirm-email').textContent = data.email || '';
      document.getElementById('confirm-subject').textContent = data.subject || '';
      document.getElementById('confirm-message').textContent = data.message || '';
      
      // 任意項目（値がある場合のみ表示）
      const phoneSection = document.getElementById('phone-section');
      const budgetSection = document.getElementById('budget-section');
      const deadlineSection = document.getElementById('deadline-section');
      
      if (data.phone && data.phone.trim()) {
        document.getElementById('confirm-phone').textContent = data.phone;
        phoneSection.classList.remove('hidden');
      } else {
        phoneSection.classList.add('hidden');
      }
      
      if (data.budget && data.budget.trim()) {
        document.getElementById('confirm-budget').textContent = data.budget;
        budgetSection.classList.remove('hidden');
      } else {
        budgetSection.classList.add('hidden');
      }
      
      if (data.deadline && data.deadline.trim()) {
        document.getElementById('confirm-deadline').textContent = data.deadline;
        deadlineSection.classList.remove('hidden');
      } else {
        deadlineSection.classList.add('hidden');
      }
    }
    
    // 隠しフォームにデータを設定する関数
    function setHiddenFormData(data: any) {
      (document.getElementById('hidden-name') as HTMLInputElement).value = data.name || '';
      (document.getElementById('hidden-email') as HTMLInputElement).value = data.email || '';
      (document.getElementById('hidden-phone') as HTMLInputElement).value = data.phone || '';
      (document.getElementById('hidden-subject') as HTMLInputElement).value = data.subject || '';
      (document.getElementById('hidden-budget') as HTMLInputElement).value = data.budget || '';
      (document.getElementById('hidden-deadline') as HTMLInputElement).value = data.deadline || '';
      (document.getElementById('hidden-message') as HTMLInputElement).value = data.message || '';
    }

    
    // ページを離れる際の警告（データ保護のため）
    window.addEventListener('beforeunload', function(e) {
      if (sessionStorage.getItem('contactFormData')) {
        e.preventDefault();
        e.returnValue = 'ページを離れると入力内容が失われます。よろしいですか？';
      }
    });
  });
</script>

<style>
  /* 確認内容表示の装飾 */
  .confirm-item {
    border-bottom: 1px solid #e2e8f0;
    padding-bottom: 1rem;
    margin-bottom: 1.5rem;
  }
  
  .confirm-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
  }
  
  /* アニメーション効果 */
  .fade-in-up {
    opacity: 0;
    transform: translateY(20px);
    animation: fadeInUp 0.6s ease-out forwards;
  }
  
  @keyframes fadeInUp {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* ボタンホバー効果 */
  button:hover {
    transform: translateY(-2px);
  }
  
  /* レスポンシブ対応 */
  @media (max-width: 640px) {
    .flex.flex-col.sm\\:flex-row > div:first-child {
      margin-bottom: 0.5rem;
    }
  }
</style>